#!/bin/bash

### Params and color codes
PORT=3050
export BLA="\033[30m"
export RED="\033[31m"
export GRE="\033[32m"
export YEL="\033[33m"
export BLU="\033[34m"
export MAG="\033[35m"
export CYA="\033[36m"
export WHI="\033[37m"

### Try to source .env
if [[ -f .env ]]; then
  source .env
else
  echo "No .env file found! Copy and edit from .env-template"
  exit 1
fi

### Check docker is installed
if ! $(command -v docker 2>/dev/null 1>&2); then
  echo -e "${RED} Docker is not installed! ${WHI}" && exit 1
fi

### Print menu if no argument provided
clear
choice=$1
if [[ -z $choice ]]; then
  echo -e """${GRE}
  =======================================================
  DOCKER MANAGER

  ${CYA}(Enter ${RED}number${CYA} as argument to skip this step)${GRE}
  =======================================================
  ${RED}1${GRE}. Run php:5.6.30-apache /test
  ${RED}2${GRE}. Run php:5.6.30-apache /DatasetTracker
  ${RED}3${GRE}. Run php:7.2.24-apache /test
  ${RED}4${GRE}. Run php:7.2.24-apache /DatasetTracker
  ${RED}5${GRE}. Clean up
  =======================================================
  ${WHI} """
  echo -e "${RED}Choose an action by number:${WHI}"
  read choice
fi

### Check that choice is a number
if [[ ! $choice =~ [0-9] ]]; then
  echo -e "${RED} You must select a number! ${WHI}" && exit 1
fi

############################################################
### Act on choice
############################################################

if [[ $choice -eq 1 ]]; then

  echo ">>> Running php:5.6.30-apache on ./test..."
  sleep 1
  docker build --tag myphp56apache -f ./Dockerfile.php56 .
  docker run -p $PORT:80 -v $PWD/test:/var/www/html myphp56apache

elif [[ $choice -eq 2 ]]; then

  echo ">>> Running php:5.6.30-apache on ./DatasetTracker..."
  sleep 1
  docker-compose -f docker-compose.legacy.yml up --build --remove-orphans

elif [[ $choice -eq 3 ]]; then

  echo ">>> Running php:7.2.24-apache on ./test..."
  sleep 1
  docker build --tag myphp72apache -f ./Dockerfile.php72 .
  docker run -p $PORT:80 -v $PWD/test:/var/www/html myphp72apache

elif [[ $choice -eq 4 ]]; then

  echo ">>> Running php:7.2.24-apache on ./DatasetTracker..."
  sleep 1
  docker-compose -f docker-compose.target.yml up --build --remove-orphans
  echo ">>> Spinning down php:7.2.24-apache on ./DatasetTracker..."
  sleep 1
  docker-compose -f docker-compose.target.yml down

elif [[ $choice -eq 5 ]]; then

  ### If you get unexpected behavior/failure, try running cleaning things
  ### up here and try again
  echo ">>> Cleaning up docker containers..."
  sleep 1
  docker-compose -f docker-compose.legacy.yml down
  docker-compose -f docker-compose.target.yml down
  docker system prune -y
  docker container prune -y
  docker image rm myphp56apache myphp72apache

else

  echo "Invalid selection!"

fi
